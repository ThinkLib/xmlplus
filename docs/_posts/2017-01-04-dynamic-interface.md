# 动态接口

---

在上一章，结合示例讲了如何构建自定义组件，以及如何从抽象的角度看待组件。抽象的意义在于封装用户不必知道的细节，只暴露用户需要知晓的接口。从这一章开始就来具体谈谈与组件相关的接口。

组件的接口可分为静态接口与动态接口两部分。所谓静态接口，可以理解为组件在初始化时允许给组件提供的参数。而由函数项所返回的公有属性或者函数，则是可被使用任意多次的，称为动态接口。这属于本框架系统的说法。

静态接口由标签属性、相关联的配置项以及初始项按一定的优先级综合指定，最后生成的参数值会被当作函数项的第三个参数传入。动态接口按提供者划分，又可以分为系统接口与用户自定义接口。本章只谈动态接口，静态接口留待下一章讲述。

## 系统提供的动态接口

系统提供的动态接口按功能来划分，可以划分为六大类：

### 与组件生命周期相关的接口

这类接口主要完成组件对象的创建、移除与替换的操作。

- append：给当前对象子级追加一个对象
- before：在当前对象之前插入一个对象
- replace：替换掉当前对象
- remove：移除掉当前对象

### 与组件通信相关接口

这类接口用于在各组件对象之间进行通信。通信分为两类，一类是事件通信，另一类是消息通信。下面的系统接口中，前四者属于事件通信接口，后四者属于消息通信接口。

- on：侦听事件
- off：取消事件侦听
- once：仅一次侦听事件
- trigger：派发事件
- watch：侦听消息
- unwatch：取消消息侦听
- glance：仅一次侦听消息
- notify：派发消息

### 组件检索接口

这类接口用于在视图项的组件对象集中检索相关的组件对象。

- find：以当前节点为上下文查找对象，返回系统接口对象集
- get：以当前节点某一子节点对象，返回系统接口对象
- first：获取当前节点的第一个子节点对象，返回系统接口对象
- last：获取当前节点的最后一个子节点对象，返回系统接口对象
- next：获取当前节点的下一个节点对象，返回系统接口对象
- prev：获取当前节点的前一个节点对象，返回系统接口对象
- children：获取当前节点的所有子节点对象，返回系统接口对象集
- sys：以文档节点为上下文查找对象，返回系统接口对象集
- items：以文档节点为上下文查找对象，返回组件自定义接口对象集

上面的接口中，最后两个比较特殊，它们属于通用检索接口，分别等于函数项的前两个形参。对于它们，在后续的《检索》章节中会有详细介绍，此处不表。

### 组件对象信息接口

这类接口用于获取或者设置与组件对象相关联的一些信息。

- value：用于获取组件的用户自定义的动态接口对象
- localName：用于获取组件名
- namespace：用于获取组件所属的命名空间
- guid：用于获取组件的唯一标识符
- toString：用于获得组件的id或者唯一标识符
- serialize：用于序列化视图项或者视图项所对应的html元素
- data：用于获取或者设置组件所绑定的数据
- removeData：用于移除组件所绑定的数据

### 与DOM元素对象操作相关的接口

由于每一组件对象都对应一个DOM元素对象，所以组件对象提供了相关的操作`DOM`元素对象的接口。通过这些系统接口可以间接地操作`DOM`元素对象，以下简称`DOM`对象为节点。

- text：获取或者设置节点的文本
- prop：获取或者设置节点的属性值
- removeProp：移除节点的属性值
- attr：获取或者设置节点的属性值
- removeAttr：移除节点的属性值
- addClass：添加css类
- removeClass：移除css类
- contains：判断当前对象的是否包含给定对象
- css：获取或者设置样式值
- show：显示节点
- hide：隐藏节点
- width：获取节点的宽度
- height：获取节点的高度
- offsetParent：显示或者隐藏节点
- offset：获取节点的偏移
- position：获取节点的位置
- scrollTop：显示或者隐藏节点
- scrollLeft：显示或者隐藏节点

### 全局接口

上面的五类系统接口均由组件对象提供。除此以外，还有另一类全局的系统接口，由全局对象`xmlplus`提供。下面给出所有的全局接口列表。

- startup：执行一个组件。
- guid：获取一唯一的全局标识符。
- error：抛出一个错误。
- ready：在页面文档加载后激活回调函数。
- type：判断一个对象的所属类型。
- isWindow：判断一个对象是不是窗体。
- isArray：判断一个对象是不是数组类型。
- isArrayLike：判断一个对象是否伪数组。
- isFunction：判断一个对象是不是函数类型。
- isNumeric：判断一个对象是否数值型。
- isPlainObject：判断一个对象是简单对象。
- isEmptyObject：判断一个对象是否空对象。
- isInnerObject：判断一个对象是否框架的内部对象。
- extend：从一个对象继承另一个对象的接口属性。
- expand：对系统接口进行扩展。
- each：遍历一个数组或者其它对象。
- parseXML：解析一个xml字符串。
- hasNamespace：判断系统是否存在指定的命名空间。
- hasComponent：判断系统是否存在指定的组件。
- clearLibrary：清除系统内部组件库。
- getElementById：由html文档中的ID属性值获取组件对象。
- getElementByGuid：由全局唯一标识符获取组件对象。

对于这些接口的使用，后续会有相应的章节作详细介绍。这里仅通过一个简单的示例，以初步了解系统接口是如何工作的。

```js
xmlplus("ui", function ( xp, $_, t) {
  $().imports({
      Index: {
          xml: "<button id='foo'>foo</button>",
          fun: function( sys, items, opts ) {
              console.log(xp.isArray([])); // 这里xp与xmlplus等价
              sys.foo.on("click", function ( event ) {
                  console.log("hello, world");
              });
              sys.foo.css("border", "1px solid red").text("bar");
          }
      }
  });
});
``` 

示例中，组件Index仅包含视图项和函数项。其中，视图项包含一个命名为`foo`的`button`元素。在函数项的第一行，全局对象`xp`调用了函数`isArray`。其后，系统对象`ys.foo`调用系统函数`on`来注册`click`事件的侦听器，当用户点击按钮时侦听函数就会被调用。最后，系统对象`sys.foo`调用了`css`和`text`两个函数，它们分别用于设定按钮的边框样式和显示文本。需要注意的是，这里的`css`函数的返回值等于`sys.foo`，这说明对`css`函数是支持链式调用。

## 用户自定义的动态接口

不同于系统接口，用户自定义的动态接口由函数项返回，这里的用户指的是组件的设计者。通过函数项的第二个参数可以获取相应组件的动态接口。下面结合前面设计的组件`IPv4Box`来看看如何使用用户自定义的动态接口。

```js
Index: {
    xml: "<Ipv4Box id='list'/>",
    fun: function( sys, items, opts ) {
        items.list.val([192,168,0,1]);
        console.log(items.list.val());
        console.log(sys.list.value() == items.list);
    }
}
```
 
对于接口val的使用，前一章已经讲过了，这里主要注意函数项的最后一行。运行示例，控制台打印出的值是`true`，这说明系统函数`sys.list.value`的返回值与`items.list`是相等的。下面是value接口的一种可能的使用方式：

```js
 1sys.list.css("color","blue").value().val([192,168,0,1]);
```

上面代码中，系统函数`css`返回的是`sys.list`的引用，系统函数`value`属于`sys.list`的一个接口。`value`函数不用提供任何的输入参数，它返回的是对等的`items.list`的引用。在某些场合，这可以简化代码的书写。

## 不同类型对象的接口差异

在《组件与空间》中，描述了系统内部的五种组件类型。按照拥有的接口数量划分，可以分为两类，其中`HTML`元素和自定义组件拥有所有的系统接口（排除`sys`与`items`），而其余的组件，包括文本，`CDATASection`描述以及注释，则只拥有如下的部分系统接口。

- before：在当前对象之前插入一个对象
- replace：替换掉当前对象
- remove：移除掉当前对象
- next：获取当前节点的下一个节点对象，返回系统接口对象集
- prev：获取当前节点的前一个节点对象，返回系统接口对象集
- text：获取或者设置节点的文本
- guid：用于获取组件的唯一标识符
- toString：用于获得组件的id或者唯一标识符

另外，根据系统的运行环境不同，`HTML`元素和自定义组件所拥有系统接口也有区别。在浏览器端，它们拥有前面所述的所有的系统接口。但在服务器端，以下接口不可见。

- show：显示节点
- hide：隐藏节点
- width：获取节点的宽度
- height：获取节点的高度
- offsetParent：显示或者隐藏节点
- offset：获取节点的偏移
- position：获取节点的位置
- scrollTop：显示或者隐藏节点
- scrollLeft：显示或者隐藏节点